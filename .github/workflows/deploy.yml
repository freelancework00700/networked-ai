name: Deploy On OVH

on:
  push:
    branches:
      - main
      - development
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    # ðŸ”¥ Select GitHub Environment
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}

    permissions:
      contents: read

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.OVH_HOST }}
          port: ${{ secrets.OVH_PORT }}
          username: ${{ secrets.OVH_USER }}
          key: ${{ secrets.OVH_SSH_KEY }}
          passphrase: ${{ secrets.OVH_SSH_KEY_PASSPHRASE }}

          script: |
            set -e

            # -----------------------------
            # Node version
            # -----------------------------
            NODE_VERSION=24

            if [ -s "$HOME/.nvm/nvm.sh" ]; then
              echo "ðŸ”§ Loading NVM"
              . "$HOME/.nvm/nvm.sh"
              nvm install $NODE_VERSION
              nvm use $NODE_VERSION
            else
              echo "âš ï¸ NVM not found, using system Node"
            fi

            echo "ðŸŸ¢ Node version: $(node -v)"
            echo "ðŸ“¦ NPM version: $(npm -v)"

            # -----------------------------
            # Select environment
            # -----------------------------
            if [ "${{ github.ref }}" = "refs/heads/main" ]; then
              BRANCH="main"
              APP_PATH="/home/ubuntu/projects/networked-ai/production/frontend"
              PM2_ID=4
              NODE_ENV="production"
              echo "ðŸš€ Deploying PRODUCTION"
            else
              BRANCH="development"
              APP_PATH="/home/ubuntu/projects/networked-ai/development/frontend"
              PM2_ID=3
              NODE_ENV="development"
              echo "ðŸ§ª Deploying DEVELOPMENT"
            fi

            cd $APP_PATH

            echo "ðŸ“¦ Updating code..."
            git fetch --all
            git reset --hard origin/$BRANCH

            echo "ðŸ§ª Creating .env from GitHub Environment secrets..."
            cat > .env << EOF
            NODE_ENV=$NODE_ENV
            PORT=${{ secrets.PORT }}

            API_URL=${{ secrets.API_URL }}
            SOCKET_URL=${{ secrets.SOCKET_URL }}
            FRONTEND_URL=${{ secrets.FRONTEND_URL }}
            DASHBOARD_URL=${{ secrets.DASHBOARD_URL }}

            TENOR_API_KEY=${{ secrets.TENOR_API_KEY }}
            OPEN_AI_API_KEY=${{ secrets.OPEN_AI_API_KEY }}

            FIREBASE_APP_ID=${{ secrets.FIREBASE_APP_ID }}
            FIREBASE_API_KEY=${{ secrets.FIREBASE_API_KEY }}
            FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}
            FIREBASE_AUTH_DOMAIN=${{ secrets.FIREBASE_AUTH_DOMAIN }}
            FIREBASE_STORAGE_BUCKET=${{ secrets.FIREBASE_STORAGE_BUCKET }}
            FIREBASE_MEASUREMENT_ID=${{ secrets.FIREBASE_MEASUREMENT_ID }}
            FIREBASE_MESSAGING_SENDER_ID=${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}

            MAPTILER_API_KEY=${{ secrets.MAPTILER_API_KEY }}
            UNSPLASH_API_KEY=${{ secrets.UNSPLASH_API_KEY }}

            STRIPE_PUBLISHABLE_KEY=${{ secrets.STRIPE_PUBLISHABLE_KEY }}
            EOF

            echo "ðŸ“¦ Installing dependencies..."
            npm install

            echo "ðŸ—ï¸ Building frontend..."
            npm run build

            echo "â™»ï¸ Restarting PM2..."
            pm2 restart $PM2_ID

            echo "âœ… Deployment completed successfully"
