name: Build and Release

on:
  push:
    branches:
      - main
      - development
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    environment: ${{ (github.ref == 'refs/heads/main' || github.event.inputs.branch == 'main') && 'production' || 'development' }}
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Install dependencies
        run: npm install

      - name: Creating .env file
        run: |
          cat > .env << EOF
          PORT=${{ secrets.PORT }}
          API_URL=${{ secrets.API_URL }}
          SOCKET_URL=${{ secrets.SOCKET_URL }}
          FRONTEND_URL=${{ secrets.FRONTEND_URL }}
          TENOR_API_KEY=${{ secrets.TENOR_API_KEY }}
          OPEN_AI_API_KEY=${{ secrets.OPEN_AI_API_KEY }}
          FIREBASE_APP_ID=${{ secrets.FIREBASE_APP_ID }}
          MAPTILER_API_KEY=${{ secrets.MAPTILER_API_KEY }}
          UNSPLASH_API_KEY=${{ secrets.UNSPLASH_API_KEY }}
          FIREBASE_API_KEY=${{ secrets.FIREBASE_API_KEY }}
          FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_AUTH_DOMAIN=${{ secrets.FIREBASE_AUTH_DOMAIN }}
          STRIPE_PUBLISHABLE_KEY=${{ secrets.STRIPE_PUBLISHABLE_KEY }}
          FIREBASE_STORAGE_BUCKET=${{ secrets.FIREBASE_STORAGE_BUCKET }}
          FIREBASE_MEASUREMENT_ID=${{ secrets.FIREBASE_MEASUREMENT_ID }}
          FIREBASE_MESSAGING_SENDER_ID=${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          EOF

      - name: Build app
        run: npm run build
        env:
          NODE_ENV: production

      - name: Create build zip
        if: github.ref == 'refs/heads/main' || github.event.inputs.branch == 'main'
        run: |
          cd dist/browser
          zip -r ../../build.zip .

      - name: Get version from package.json
        if: github.ref == 'refs/heads/main' || github.event.inputs.branch == 'main'
        id: version
        run: |
          VERSION="$(node -p "require('./package.json').version")"
          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Create Release
        if: github.ref == 'refs/heads/main' || github.event.inputs.branch == 'main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}-${{ github.run_number }}
          name: Release v${{ steps.version.outputs.VERSION }}-${{ github.run_number }}
          body: |
            ## Live Update Release

            This release contains the latest build for live updates.

            **Version:** ${{ steps.version.outputs.VERSION }}-${{ github.run_number }}
            **Build Date:** ${{ github.event.head_commit.timestamp || github.run_started_at }}

            ### How to use:
            1. The app will automatically check for updates on startup
            2. If an update is available, it will be downloaded and applied
            3. The app will reload with the new version
          files: build.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy to Production
        if: github.ref == 'refs/heads/main' || github.event.inputs.branch == 'main'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.OVH_HOST }}
          port: ${{ secrets.OVH_PORT }}
          key: ${{ secrets.OVH_SSH_KEY }}
          username: ${{ secrets.OVH_USER }}
          passphrase: ${{ secrets.OVH_SSH_KEY_PASSPHRASE }}
          script: |
            cd /home/ubuntu/projects/networked-ai/production/frontend || exit 1
            git fetch --all
            git reset --hard origin/main
            npm install
            npm run build
            pm2 restart 4

      - name: Deploy to Staging
        if: github.ref == 'refs/heads/development' || github.event.inputs.branch == 'development'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.OVH_HOST }}
          port: ${{ secrets.OVH_PORT }}
          key: ${{ secrets.OVH_SSH_KEY }}
          username: ${{ secrets.OVH_USER }}
          passphrase: ${{ secrets.OVH_SSH_KEY_PASSPHRASE }}
          script: |
            cd /home/ubuntu/projects/networked-ai/development/frontend || exit 1
            git fetch --all
            git reset --hard origin/development
            npm install
            npm run build
            pm2 restart 3

      - name: Clean up
        if: always()
        run: |
          rm -f .env build.zip
        shell: bash
