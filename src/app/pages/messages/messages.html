@if (isLoggedIn()) {
  <ion-header mode="md">
    <ion-toolbar>
      <div class="flex items-center gap-4 p-6 max-w-[672px] mx-auto">
        <searchbar
          class="w-full"
          [searchQuery]="searchInput()"
          (clear)="searchInput.set('')"
          (searchChange)="searchInput.set($event)"
          placeholder="Search by username, email or phone"
        />
        <app-button (click)="startNewChat()" [icon]="'assets/svg/chatIcon.svg'" iconPos="left" />
      </div>
    </ion-toolbar>
  </ion-header>
}

<ion-content [fullscreen]="true" [scrollEvents]="true">
  @if (isLoggedIn()) {
    <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)" mode="md">
      <ion-refresher-content mode="md"></ion-refresher-content>
    </ion-refresher>
    <div class="w-full pt-0 max-w-[672px] mx-auto">
      <!-- Tabs -->
      <div class="flex gap-2 p-4 overflow-x-auto scrollbar-hide" style="flex-wrap: nowrap">
        @for (tab of tabs; track tab.value) {
          <button type="button" class="filter-button" [class.active]="activeTab() === tab.value" (click)="activeTab.set(tab.value)">
            {{ tab.label }}
          </button>
        }
      </div>

      <!-- Messages List -->
      @if (isLoading() && getFilteredChatRooms().length === 0) {
        <div class="flex justify-center items-center py-8">
          <ion-spinner></ion-spinner>
        </div>
      } @else if (getFilteredChatRooms().length > 0) {
        <ion-list>
          @for (room of getFilteredChatRooms(); track room.id) {
            <ion-item-sliding>
              <ion-item (click)="goToChat(room)">
                <ion-avatar class="relative">
                  <!-- Main avatar image -->
                  <div class="relative w-full h-full rounded-full overflow-hidden">
                    <img
                      fill
                      placeholder
                      class="rounded-full object-cover"
                      (error)="onImageError($event)"
                      [ngSrc]="getImageUrl(getChatImage(room))"
                    />
                  </div>

                  <!-- GROUP BADGE -->
                  @if (isGroupChat(room)) {
                    <div
                      class="absolute -bottom-1 -right-1 bg-[#0A9E57] !shadow-[0_16px_32px_0_rgba(7,40,70,0.10)] border-2 border-white !rounded-[12px] w-6 h-6 flex items-center justify-center hover:brightness-95 transition-all"
                    >
                      <img src="assets/svg/users.svg" class="w-3 h-3" />
                    </div>
                  }

                  <!-- EVENT BADGE -->
                  @else if (isEventChat(room)) {
                    <div
                      class="absolute -bottom-1 -right-1 bg-brand-04 !shadow-[0_16px_32px_0_rgba(7,40,70,0.10)] border-2 border-white !rounded-[12px] w-6 h-6 flex items-center justify-center hover:brightness-95 transition-all"
                    >
                      <i class="pi pi-th-large !text-[10px]"></i>
                    </div>
                  }
                </ion-avatar>

                <ion-label class="pl-3">
                  <div class="body-14M neutral-01 pb-1">{{ getChatName(room) }}</div>
                  <div class="body-12M neutral-02">
                    @if (room.lastMessage) {
                      {{ room.lastMessage }}
                    }
                  </div>
                </ion-label>

                <div class="flex flex-col items-end justify-center gap-1 pr-2">
                  <span class="text-xs text-gray-500 pb-1">
                    {{ formatTime(room.lastMessageTime || room.updated_at) }}
                  </span>
                  <div class="flex items-center gap-3">
                    <!-- TODO: Show mute icon when API provides mute status -->
                    @if (getUnreadCount(room) > 0) {
                      <ion-badge class="h-6 w-6 rounded-full flex items-center justify-center neutral-02">
                        {{ getUnreadCount(room) }}
                      </ion-badge>
                    }
                  </div>
                </div>
              </ion-item>

              <ion-item-options side="end" class="flex items-center gap-2 pr-2">
                <!-- Mute Button -->
                <ion-item-option slot="icon-only" (click)="muteChat(room)" class="p-0 rounded bg-gray-200 w-10 h-10 flex items-center justify-center">
                  <!-- TODO: Show muted icon when API provides mute status -->
                  <img src="assets/svg/alertOffBlackIcon.svg" class="w-5 h-5" />
                </ion-item-option>

                <!-- Delete Button -->
                <ion-item-option
                  color="danger"
                  slot="icon-only"
                  (click)="deleteChat(room)"
                  class="p-0 rounded w-10 h-10 flex items-center justify-center"
                >
                  <img src="assets/svg/deleteWhiteIcon.svg" class="w-5 h-5" />
                </ion-item-option>
              </ion-item-options>
            </ion-item-sliding>
          }
        </ion-list>

        <!-- Infinite Scroll -->
        <ion-infinite-scroll threshold="100px" (ionInfinite)="loadMoreRooms($event)" [disabled]="!hasMoreRooms()">
          <ion-infinite-scroll-content loadingSpinner="bubbles" loadingText="Loading more chats..." />
        </ion-infinite-scroll>
      } @else {
        <div class="flex items-center justify-center h-full min-h-[400px]">
          <div class="flex flex-col items-center justify-center gap-3 text-center">
            <div class="bg-white rounded-2xl shadow-md p-3 flex items-center justify-center">
              <div class="icon-container">
                <i class="pi pi-search text-white text-xl"></i>
              </div>
            </div>
            <div class="text-[20px] font-semibold neutral-01">No Messages Yet</div>
            <div class="body-14M text-surface-600">Start a new chat with a network!</div>
            <app-button (click)="startNewChat()" [label]="'Start a New Chat'" [icon]="'assets/svg/chatIcon.svg'" iconPos="left" />
          </div>
        </div>
      }
    </div>
  } @else {
    <auth-empty-state type="messages" />
  }
</ion-content>
