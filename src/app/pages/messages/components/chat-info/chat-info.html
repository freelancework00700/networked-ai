<ion-header mode="md">
  <ion-toolbar>
    <div class="flex items-center justify-between px-4 py-2 max-w-[672px] mx-auto">
      <i class="pi pi-arrow-left cursor-pointer" (click)="isEditingName() ? cancelEditGroupName() : handleBack()"></i>

      <div class="body-16M neutral-01">
        {{ isEditingName() ? 'Change group name' : 'Group info' }}
      </div>

      @if (!isEditingName()) {
        <i class="pi pi-ellipsis-v cursor-pointer" (click)="openMenu()"></i>
      } @else {
        <div class="w-4"></div>
      }
    </div>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" mode="md">
  <div class="w-full max-w-[672px] mx-auto p-4 flex flex-col gap-6">
    @if (isEditingName()) {
      <input pInputText autofocus class="h-[44px]" [value]="tempGroupName()" (input)="onGroupNameInput($event)" placeholder="Enter group name" />
    } @else {
      <div class="flex flex-col items-center gap-2">
        <input type="file" #fileInput accept="image/jpeg,image/png" class="hidden" (change)="onGroupImageSelected($event)" />

        <div
          class="relative w-20 h-20 rounded-full bg-neutral-04 flex items-center justify-center cursor-pointer hover:brightness-90 transition overflow-hidden"
          [class.pointer-events-none]="isSavingGroupImage()"
          [class.opacity-70]="isSavingGroupImage()"
          (click)="onGroupImageMenuClick($event)"
        >
          @if (groupImage()) {
            <div class="relative w-full h-full rounded-full overflow-hidden">
              <img fill placeholder (error)="onImageError($event)" class="rounded-full object-cover" [ngSrc]="getImageUrl(groupImage() || '')" />
            </div>
          } @else {
            <i class="pi pi-camera text-xl text-white"></i>
          }
          @if (isSavingGroupImage()) {
            <div class="absolute inset-0 rounded-full bg-black/30 flex items-center justify-center">
              <ion-spinner name="crescent" class="scale-75"></ion-spinner>
            </div>
          }
        </div>

        <p-menu #groupImageMenu [popup]="true" [model]="groupImageMenuItems()" appendTo="body"></p-menu>

        <div class="body-16M neutral-01">{{ groupName() }}</div>
        <div class="text-xs text-gray-500">Group Â· {{ members().length }} members</div>
        <div class="text-xs text-gray-400">
          Created by
          @if (chatRoom()?.created_by_user?.id === authService.currentUser()?.id) {
            <span>you</span>
          } @else {
            <span>{{ chatRoom()?.created_by_user?.name || chatRoom()?.created_by_user?.username }}</span>
          }
          , {{ createdDate() }}
        </div>
      </div>

      <div class="flex gap-3">
        <app-button iconName="pi-upload" label="Share Group" class="flex-1" color="secondary" (click)="openShareGroup()" />

        <app-button icon="assets/svg/addUserIcon.svg" label="Add Members" class="flex-1" (click)="addMembers()" />
      </div>

      <div class="flex items-center justify-between py-3">
        <div class="flex items-center gap-2">
          <app-button icon="assets/svg/alertBlackIcon.svg" radius="50px" />
          <span class="body-14M neutral-01">Notification Settings</span>
        </div>

        <p-toggleSwitch [(ngModel)]="notificationsOn"></p-toggleSwitch>
      </div>

      <div>
        <div class="body-14M neutral-01 mb-2">{{ members().length }} Members</div>

        @for (m of members(); track m.id) {
          <div class="flex items-center gap-3 py-3 border-b border-gray-200" (click)="onUserClick(m)">
            <div class="w-12 h-12 rounded-full overflow-hidden relative">
              <img fill placeholder class="rounded-full object-cover" (error)="onImageError($event)" [ngSrc]="getImageUrl(m?.thumbnail_url ?? '')" />
            </div>

            <div class="flex-1">
              <div class="flex items-center gap-2">
                <span class="font-medium">
                  {{ m.name || m.username }}
                  @if (m.id === authService.currentUser()?.id) {
                    <span class="text-xs text-gray-400">(You)</span>
                  }
                </span>

                <div class="flex items-center gap-1 border border-gray-300 rounded-full px-2 h-[20px]">
                  <img [src]="getDiamondPath(m)" class="h-4" />
                  <span class="text-xs font-semibold">{{ m.total_gamification_points }}</span>
                </div>
              </div>

              @if (m.company_name) {
                <div class="text-xs text-gray-500">{{ m.company_name }}</div>
              }
            </div>
          </div>
        }
      </div>

      <button class="flex items-center justify-center gap-2 accent-red mt-4" (click)="leaveGroup()">
        <i class="pi pi-sign-out"></i>
        <span class="body-14M">Leave Group</span>
      </button>
    }
  </div>
</ion-content>
<ion-footer mode="md">
  <ion-toolbar>
    <div class="p-4 max-w-[672px] mx-auto">
      @if (isEditingName()) {
        <app-button
          label="Save"
          class="w-full"
          [disabled]="!tempGroupName().trim() || isSavingGroupName()"
          [isLoading]="isSavingGroupName()"
          (click)="saveGroupName()"
        />
      }
    </div>
  </ion-toolbar>
</ion-footer>
