<ion-header mode="md">
  <ion-toolbar>
    <div class="flex items-center justify-between px-4 pt-2.5 cursor-pointer max-w-[672px] mx-auto">
      <i class="pi pi-arrow-left" (click)="back()"></i>
      <div class="body-14M">Guest List</div>
      <div
        [class]="isDownloading() ? 'pi pi-spinner pi-spin' : 'pi pi-download'"
        [class.disabled]="isDownloading()"
        (click)="downloadGuestList()"
      ></div>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content fullscreen mode="md">
  <div class="h-full flex justify-center">
    <div class="w-full max-w-[672px] p-6 flex flex-col">
      <div class="grid grid-cols-4 gap-2 my-4">
        @for (item of stats(); track item.key) {
          <div class="stat-border {{ item.class }}">
            <div class="stat-card">
              <div class="body-12M">{{ item.label }}</div>
              <div class="body-16SB">{{ item.value }}</div>
            </div>
          </div>
        }
      </div>

      <!-- <app-button [label]="'Add Guest'" [icon]="'assets/svg/addUserIcon.svg'" /> -->

      <div class="flex gap-2 mt-4">
        <searchbar
          class="w-full"
          [searchQuery]="searchQuery()"
          (searchChange)="searchQuery.set($event)"
          (clear)="searchQuery.set('')"
          [placeholder]="'Search'"
        />

        <app-button icon="/assets/svg/network/filterIcon.svg" color="secondary" variant="outlined" (click)="openFilterModal()" />
      </div>

      <div class="flex items-center gap-2 mt-3 text-sm">
        <ion-icon src="assets/svg/checkmark-circle.svg" class="w-6 h-6" />
        <div class="body-16M">Checked-in: <span class="font-bold">{{ checkedInCount() }}</span></div>
      </div>

      @if (isLoading()) {
        <div class="flex items-center justify-center py-8">
          <div class="body-14M neutral-03">Loading guests...</div>
        </div>
      } @else {
        <div class="mt-4 space-y-3">
          @for (s of filteredGuestList(); track s.id) {
            <div class="flex items-center gap-3 py-3 border-b border-gray-200">
              <div class="relative w-12 h-12 rounded-full overflow-hidden">
                <img 
                  [ngSrc]="getImageUrl(s.imageUrl)" 
                  [alt]="s.name" 
                  fill
                  placeholder
                  (error)="onImageError($event)"
                  class="object-cover rounded-full" 
                />

              @if (s.checkedIn) {
                <ion-icon src="assets/svg/checkmark-circle.svg" class="w-5 h-5 absolute -bottom-1 -right-1" />
              }
            </div>

            <div class="flex-1">
              <div class="flex items-center gap-2">
                <span class="font-medium truncate">{{ s.name }}</span>

                <div class="flex items-center gap-1 border border-gray-300 rounded-full px-2 h-[20px]">
                  <img src="assets/svg/diamondYellow.svg" class="h-4" />
                  <span class="text-xs font-semibold">{{ s.value }}</span>
                </div>
              </div>

              <div class="flex flex-wrap gap-1 mt-1">
                <span class="text-[10px] px-2 py-0.5 rounded-full border border-surface-300 text-surface-600">
                  {{ s.ticketType }}
                </span>

                @if (s.paymentStatus === 'paid') {
                  <span class="text-[10px] px-2 py-0.5 rounded-full bg-green-100 text-[#1D6D46]"> Paid </span>
                } @else {
                  <span class="text-[10px] px-2 py-0.5 rounded-full bg-orange-100 text-[#9E660A]"> Unpaid </span>
                }

                @if (s.paymentMode === 'in-app') {
                  <span class="text-[10px] px-2 py-0.5 rounded-full bg-green-100 text-[#1D6D46]"> In-App </span>
                } @else {
                  <span class="text-[10px] px-2 py-0.5 rounded-full bg-blue-100 text-[#1D386D] ]"> On the spot </span>
                }
              </div>
            </div>

            @if (!s.checkedIn) {
              <app-button label="Check In" height="30px" />
            }

            <p-button
              icon="pi pi-ellipsis-v"
              (click)="menu.toggle($event)"
              class="p-button-text p-button-rounded"
              [variant]="'text'"
              [severity]="'secondary'"
              [style]="{ height: '30px' }"
            ></p-button>
          </div>
          <p-menu #menu [popup]="true" [model]="items" appendTo="body">
            <ng-template pTemplate="item" let-item>
              <div class="flex items-center gap-2 px-3 py-2 hover:bg-gray-100 rounded cursor-pointer" (click)="item.command(); menu.hide()">
                @if (item.iconPath) {
                  <ion-icon [src]="item.iconPath" class="w-5 h-5" />
                }
                <span>{{ item.label }}</span>
              </div>
            </ng-template>
          </p-menu>
          } @empty {
            <app-empty-state title="No guests found" message="" />
          }
        </div>
      }
    </div>
  </div>
</ion-content>
