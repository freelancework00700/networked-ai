<ion-header mode="md" [translucent]="true">
  <ion-toolbar>
    <div class="flex justify-between items-center px-4">
      <ion-icon src="/assets/svg/back-arrow.svg" class="h-[20px] w-[20px]" (click)="goBack()"></ion-icon>
      @if (event()) {
        <div class="flex items-center gap-4">
          <ion-icon src="/assets/svg/share.svg" class="h-[20px] w-[20px]" (click)="shareEvent()"></ion-icon>
          <div class="w-[20px] h-[20px] flex items-center justify-center cursor-pointer" (click)="likeEvent()">
            @if (isEventLiked()) {
              <div class="pi pi-heart-fill !text-[19px] accent-red"></div>
            } @else {
              <ion-icon src="/assets/svg/like.svg" class="h-[20px] w-[20px]"></ion-icon>
            }
          </div>
          <ion-icon src="/assets/svg/dots-vertical.svg" class="h-[20px] w-[20px]" (click)="menu.toggle($event)"></ion-icon>
        </div>
      }
    </div>
    <p-menu #menu [popup]="true" [model]="eventMenuItems" appendTo="body"> </p-menu>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" mode="md">
  @if (isLoading()) {
    <!-- Loading State - Skeleton -->
    <div class="w-full max-w-[672px] mx-auto bg-neutral-0">
      <!-- Image Skeleton -->
      <div class="relative w-full h-[361px] bg-neutral-06">
        <ion-skeleton-text animated class="w-full h-full"></ion-skeleton-text>
      </div>

      <!-- Content Skeleton -->
      <div class="flex flex-col gap-8 pt-4 px-4">
        <!-- Chips Skeleton -->
        <div class="flex items-center gap-2">
          <ion-skeleton-text animated class="w-24 h-6 rounded-full"></ion-skeleton-text>
          <ion-skeleton-text animated class="w-20 h-6 rounded-full"></ion-skeleton-text>
        </div>

        <!-- Title Skeleton -->
        <div class="flex flex-col gap-2">
          <ion-skeleton-text animated class="w-3/4 h-6 rounded"></ion-skeleton-text>
          <ion-skeleton-text animated class="w-1/2 h-4 rounded"></ion-skeleton-text>
        </div>

        <!-- Details Skeleton -->
        <div class="flex flex-col gap-3">
          @for (i of [1, 2, 3]; track i) {
            <div class="flex items-start gap-1.5">
              <ion-skeleton-text animated class="w-4 h-4 rounded mt-0.5"></ion-skeleton-text>
              <div class="flex items-center justify-between gap-4 w-full">
                <ion-skeleton-text animated class="w-24 h-4 rounded"></ion-skeleton-text>
                <ion-skeleton-text animated class="w-32 h-4 rounded"></ion-skeleton-text>
              </div>
            </div>
          }
        </div>

        <!-- Description Skeleton -->
        <div class="flex flex-col gap-2">
          <ion-skeleton-text animated class="w-full h-4 rounded"></ion-skeleton-text>
          <ion-skeleton-text animated class="w-full h-4 rounded"></ion-skeleton-text>
          <ion-skeleton-text animated class="w-5/6 h-4 rounded"></ion-skeleton-text>
        </div>

        <!-- Map Skeleton -->
        <div class="w-full rounded-[16px] overflow-hidden" style="height: 300px">
          <ion-skeleton-text animated class="w-full h-full"></ion-skeleton-text>
        </div>
      </div>
    </div>
  } @else if (event()) {
    <!-- Event Content -->
    <div class="w-full max-w-[672px] mx-auto bg-neutral-0">
      <div class="-mt-[56px] image-container">
        <div class="bg-blur-image relative w-full h-full">
          <img
            fill
            placeholder
            priority
            [alt]="eventDisplayData().title || 'Event image'"
            class="object-cover"
            (error)="onImageError($event)"
            [ngSrc]="getImageUrl(eventDisplayData().thumbnail_url || '')"
          />
        </div>
        <div class="bg-image relative w-[80%] h-[300px]">
          <img
            fill
            placeholder
            priority
            [alt]="eventDisplayData().title || 'Event image'"
            class="object-cover"
            (error)="onImageError($event)"
            [ngSrc]="getImageUrl(mainImageUrl() || '')"
          />
        </div>
        <div class="bg-image-bottom"></div>
        @if (isShowTimer() && countdownTimer()) {
          <div class="countdown-timer">
            <span [innerHTML]="formatTimerDisplay(countdownTimer()!.formatted, countdownTimer()!.isLessThan24Hours)"></span>
          </div>
        }
      </div>
      @if (eventDisplayData().isCurrentUserAttendee) {
        <div class="px-4 pt-2" (click)="openTicketsModal()">
          <div
            class="flex items-center justify-between rounded-[12px] border border-[#DBDBDB] bg-gradient-to-r from-[#fff7ee] to-[#fefaf3] pl-1.5 pr-3 py-1.5 shadow-[2px_16px_19px_0_rgba(0,0,0,0.09)]"
          >
            <div class="flex items-center gap-1.5">
              <div class="w-10 h-10 flex items-center justify-center rounded-[8px] bg-brand-06 neutral-01 relative">
                <ion-icon src="../../../../assets/svg/ticket.svg" class="h-[20px] w-[20px]"></ion-icon>
                <ion-icon src="../../../../assets/svg/check-badge-green.svg" class="absolute bottom-0.5 right-0.5 h-[16px] w-[16px]"></ion-icon>
              </div>
              <div class="body-14R neutral-01">You've registered for this event</div>
            </div>
            <div class="flex items-center gap-1">
              <div class="body-14M brand-03">My Ticket</div>
              <div class="pi pi-arrow-right !text-[16px] brand-03"></div>
            </div>
          </div>
        </div>
      }
      <event-display
        [eventData]="eventDisplayData()"
        [selectedDate]="selectedDate()"
        [onDateChange]="onDateChange.bind(this)"
        [onUserListClick]="openUserList.bind(this)"
        [showPreviewBanner]="false"
        [showHostPromo]="true"
        [showActionButtons]="true"
        [onManageEventClick]="openMenu.bind(this)"
        [onEventChatClick]="openEventChat.bind(this)"
      />
    </div>
  } @else {
    <app-empty-state [title]="'No Events Found'" [message]="''" [showClearButton]="false" />
  }
</ion-content>
<ion-footer class="ion-padding-horizontal">
  @if (!isLoading() && event()) {
    <ion-toolbar class="ion-no-padding" style="--background: transparent">
      <div class="pb-4 max-w-[672px] mx-auto">
        @if (!isEventCompleted()) {
          @if (!eventDisplayData().isCurrentUserHost && !eventDisplayData().isCurrentUserAttendee && !eventDisplayData().isCurrentUserCoHost) {
            @if (eventDisplayData().is_subscriber_exclusive && !eventDisplayData().has_subscribed) {
              <app-button label="Subscribe Now" icon="/assets/svg/crown-black.svg" height="40px" (click)="navigateToSubscriptionPlans()" />
            } @else if (eventDisplayData().isRsvpApprovalRequired) {
              @if (eventDisplayData().isCurrentUserRequestApproved) {
                <app-button
                  [label]="eventDisplayData().rsvpButtonLabel || ''"
                  height="40px"
                  [customColor]="eventDisplayData().has_subscribed ? '#2B5BDE' : ''"
                  (click)="openRsvpModal()"
                />
              } @else if (eventDisplayData().isCurrentUserRequestRejected) {
                <app-button label="RSVP Request Rejected" height="40px" [disabled]="true" />
              } @else {
                <app-button
                  [label]="eventDisplayData().hasCurrentUserRsvpRequest ? 'Requested' : 'Send RSVP Request'"
                  height="40px"
                  [disabled]="eventDisplayData().isCurrentUserRequestPending || isSendingRsvpRequest()"
                  [isLoading]="isSendingRsvpRequest()"
                  (click)="sendRsvpRequest()"
                />
              }
            } @else {
              <app-button
                [label]="eventDisplayData().rsvpButtonLabel || ''"
                height="40px"
                [customColor]="eventDisplayData().has_subscribed ? '#2B5BDE' : ''"
                (click)="openRsvpModal()"
              />
            }
          }
        }
      </div>
    </ion-toolbar>
  }
</ion-footer>
