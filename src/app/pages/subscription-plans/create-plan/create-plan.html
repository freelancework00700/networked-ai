<ion-header mode="md">
  <ion-toolbar>
    <div class="p-6 max-w-[672px] mx-auto">
      <div class="flex items-center gap-2 cursor-pointer" (click)="previousStep()">
        <div class="pi pi-arrow-left"></div>
        <div class="body-14M neutral-02 text-center w-full">Set Up Subscription</div>
      </div>
      <div class="flex items-center justify-between mt-4">
        <div class="heading-h2 neutral-01">{{ stepHeading() }}</div>
        <!-- Steps -->
        <div class="flex items-center gap-1">
          @for (step of steps(); track step) {
            <div
              class="rounded-full transition-all duration-200"
              [ngClass]="step === currentStep() ? 'w-8 h-2 bg-black' : step < currentStep() ? 'w-2 h-2 bg-black' : 'w-2 h-2 bg-gray-300'"
            ></div>
          }
        </div>
      </div>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" mode="md">
  <div class="min-h-full">
    <div class="w-full p-4 max-w-[672px] mx-auto">
      <form [formGroup]="planForm()">
        <!-- Step 1: Plan Details -->
        @if (currentStep() === 1) {
          <app-plan-details-form
            [planForm]="planForm()"
            [benefits]="benefits()"
            [isSponsorPlan]="isSponsorPlan()"
            [benefitErrors]="benefitErrors()"
            (benefitAdded)="addBenefit()"
            (benefitRemoved)="removeBenefit($event)"
            (benefitUpdated)="updateBenefit($event.index, $event.text)"
            (benefitsReordered)="reorderBenefits($event)"
          />
        }

        <!-- Step 2: Include Events -->
        @if (currentStep() === 2) {
          <div class="flex flex-col gap-4">
            @if (isLoadingEvents()) {
              <div class="flex items-center justify-center py-8">
                <div class="body-14M neutral-03">Loading events...</div>
              </div>
            } @else if (groupedEventsKeys().length > 0) {
              <div>
                @for (group of groupedEventsKeys(); track group) {
                  <div class="flex flex-col gap-2">
                    <div class="body-16M neutral-02 pt-3">{{ group }}</div>
                    @for (event of groupedEvents()[group]; track event?.id) {
                      <subscription-event-card
                        [event]="event"
                        [selected]="selectedEvents().includes(event.id)"
                        (toggle)="toggleEventSelection($event)"
                      />
                    }
                  </div>
                }

                @if (hasMore()) {
                  <ion-infinite-scroll threshold="100px" (ionInfinite)="loadMoreEvents($event)">
                    <ion-infinite-scroll-content loadingSpinner="bubbles" loadingText="Loading more events..." />
                  </ion-infinite-scroll>
                }
              </div>
            } @else {
              <div class="flex items-center justify-center py-8">
                <div class="body-14M neutral-03 text-center">No events found. Create an event first to include it in your subscription plan.</div>
              </div>
            }
          </div>
        }

        <!-- Step 3: Preview -->
        @if (currentStep() === 3) {
          <plan-preview
            [planForm]="planForm()"
            [benefits]="benefits()"
            [selectedEvents]="selectedEvents()"
            [discountType]="discountType()"
            [events]="events()"
            [monthlyPriceValue]="monthlyPriceValue()"
            [discountValue]="discountValue()"
            [planType]="getFieldValue('is_sponsor') ? 'sponsor' : 'event'"
          />
        }
      </form>
    </div>
  </div>
</ion-content>

<ion-footer mode="md">
  <ion-toolbar mode="md">
    <div class="p-6 max-w-[672px] mx-auto">
      <div class="flex items-center gap-2">
        <!-- Secondary Button -->
        <app-button
          [label]="secondaryButton().label"
          [icon]="secondaryButton().icon"
          [color]="secondaryButton().color"
          [iconPos]="'right'"
          class="flex-1"
          (click)="secondaryButton().clickHandler()"
        />
        <!-- Primary Button -->
        <app-button
          [label]="primaryButton().label"
          [icon]="primaryButton().icon"
          [disabled]="primaryButton().disabled"
          [iconPos]="'right'"
          [customColor]="primaryButton().customColor"
          class="flex-1"
          (click)="primaryButton().clickHandler()"
          [isLoading]="isLaunching()"
        />
      </div>
    </div>
  </ion-toolbar>
</ion-footer>
