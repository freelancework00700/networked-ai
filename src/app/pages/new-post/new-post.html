<ion-header>
  <ion-toolbar>
    <div class="flex items-center gap-2 max-sm:px-4 pt-2.5 cursor-pointer max-w-[672px] mx-auto">
      <div class="pi pi-times pr-2" (click)="navCtrl.back()"></div>
      <div class="body-14M">New Post</div>
    </div>
  </ion-toolbar>
</ion-header>
<ion-content [fullscreen]="true">
  <div class="min-h-full">
    <div class="w-full max-w-[672px] mx-auto p-4 flex flex-col gap-4">
      <!-- caption-input -->
      <div class="flex items-start gap-3 py-3 pb-0 bg-neutral-07 px-4">
        <img src="/assets/images/profile.jpeg" alt="Profile" class="w-15 h-15 object-cover rounded-full" />
        <div class="flex-1 flex flex-col gap-1">
          <div class="body-14SB neutral-01">Ethan Cortazzo</div>

          <div class="relative-block-container">
            <div>
              <textarea
                #textareaRef
                class="w-full border-none outline-none resize-none"
                [formControl]="textCtrl"
                [placeholder]="'Start writing here...'"
                wrap="hard"
              ></textarea>

              <ngx-mentions
                [textInputElement]="textareaRef"
                [menuTemplate]="menuTemplate"
                [mentionsConfig]="mentionsConfig"
                [searchRegexp]="searchRegexp"
                [mentions]="mentions"
                [removeWholeTagOnBackspace]="true"
                (search)="loadChoices($event)"
                (selectedChoicesChange)="onSelectedChoicesChange($event)"
                (menuShow)="onMenuShow()"
                (menuHide)="onMenuHide()"
              ></ngx-mentions>

              <ng-template #menuTemplate let-selectChoice="selectChoice">
                <ul
                  class="ngx-selectable-list"
                  ngxKbListNavigation
                  [choices]="choices"
                  (selectChoice)="selectChoice($event)"
                  [class.loader-only]="!choices.length && loading"
                >
                  @for (user of choices; track user.id) {
                    <li class="ngx-selectable-list-item flex items-center justify-between gap-2" (click)="selectChoice(user)">
                      <!-- Left: avatar + name -->
                      <div class="flex items-center gap-2">
                        <img [src]="user.thumbnail || 'assets/images/profile.jpeg'" class="w-8 h-8 rounded-full object-cover" />
                        <span title="{{ user.name }}">{{ user.name }}</span>
                      </div>

                      <!-- Right: Networked chip -->
                      @if (user.isNetwork) {
                        <span class="text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-700 font-medium"> Networked </span>
                      }
                    </li>
                  }
                </ul>
              </ng-template>
            </div>
          </div>
        </div>
      </div>

      <!-- location -->
      @if (form().get('location')?.value) {
        <div class="flex items-start gap-1 body-14R neutral-03 pl-20">
          <i class="pi pi-map-marker mt-1"></i>
          <span class="leading-snug">
            {{ form().get('location')?.value }}
          </span>
        </div>
      }

      <!-- Media Items -->
      @if (mediaItems().length) {
        <div #swiperEl class="swiper">
          <div class="swiper-wrapper">
            @for (item of mediaItems(); track item.id) {
              <div class="swiper-slide">
                <div class="slide-content">
                  <div class="slide-image">
                    <!-- IMAGE -->
                    @if (item.type === 'image' || item.type === 'gif') {
                      <img src="{{ item.url }}" />
                    }

                    <!-- VIDEO -->
                    @if (item.type === 'video') {
                      <video src="{{ item.url }}" controls></video>
                    }

                    <div
                      class="absolute top-2 right-2 bg-black/50 text-white rounded-full w-6 h-6 flex items-center justify-center cursor-pointer"
                      (click)="deleteMedia($index)"
                    >
                      <i class="pi pi-times"></i>
                    </div>
                  </div>
                </div>
              </div>
            }
          </div>
        </div>
        <div #scrollContainer class="thumbnail-container" cdkDropList cdkDropListOrientation="horizontal" (cdkDropListDropped)="drop($event)">
          @for (item of mediaItems(); track item.id) {
            <div class="thumbnail" cdkDrag [cdkDragBoundary]="scrollContainer" (click)="goToSlide($index)">
              <!-- IMAGE -->
              @if (item.type === 'image' || item.type === 'gif') {
                <img [src]="item.url" />
              }

              <!-- VIDEO -->
              @if (item.type === 'video') {
                <video [src]="item.url" muted loop></video>
              }
              <!-- DELETE -->
              <div class="delete-btn" (click)="deleteMedia($index)">Ã—</div>
            </div>
          }
        </div>
      }

      <!-- events-card -->
      @if (eventsArray().controls.length) {
        <div class="space-y-4">
          @for (eventCtrl of eventsArray().controls; track eventCtrl.value.id) {
            <div>
              <post-event-card [event]="eventCtrl.value" (onRemove)="onRemoveEvent($event)" />
            </div>
          }
        </div>
      }

      <!-- Visibility -->
      <div class="flex items-center justify-between pl-2">
        <label class="body-16SB">Visibility</label>
        <div class="flex gap-2">
          <chip [type]="visibility()" [color]="visibility() === 'public' ? 'lgold' : ''" (selectedType)="setVisibility('public')">
            <span class="body-14R">Open to the public</span>
          </chip>
          <chip [type]="visibility()" [color]="visibility() === 'private' ? 'lgold' : ''" (selectedType)="setVisibility('private')">
            <span class="body-14R">Networked only</span>
          </chip>
        </div>
      </div>
    </div>
  </div>
</ion-content>
<ion-footer>
  <ion-toolbar>
    <div class="flex items-center justify-between p-6 max-w-[672px] mx-auto">
      <div class="action-icons flex items-center gap-6">
        <ion-icon [src]="'/assets/svg/social-feed/image-plus.svg'" (click)="openNetworkedGallery()" class="w-5 h-5" />
        <ion-icon [src]="'/assets/svg/social-feed/camera.svg'" (click)="openFilePicker()" class="w-5 h-5" />
        <ion-icon [src]="'/assets/svg/location-icon.svg'" (click)="openLocationModal()" class="w-6 h-6" />
        <ion-icon [src]="'/assets/svg/social-feed/calendar-plus.svg'" (click)="openEventModal()" class="w-5 h-5" />
      </div>

      <app-button [label]="'Post'" [disabled]="isLoading()" (click)="handleCreatePost()" width="100px" height="35px" />
    </div>
    <input
      #fileInput
      type="file"
      multiple
      accept="image/jpeg,image/png,video/mp4,video/webm,video/quicktime"
      class="hidden"
      (change)="onBrowseFiles($event)"
    />
  </ion-toolbar>
</ion-footer>
