<ion-header>
  <ion-toolbar>
    <div class="flex items-center gap-2 max-sm:px-4 pt-2.5 cursor-pointer max-w-[672px] mx-auto" (click)="previousStep()">
      <div class="pi pi-arrow-left"></div>
      @if (!isModalMode) {
        <div class="body-14M neutral-02 text-center w-full">Create an Event</div>
      } @else {
        <div class="body-14M neutral-02 text-center w-full">Edit Event {{ eventData?.title }}</div>
      }
    </div>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="min-h-full">
    <div class="w-full p-6 max-w-[672px] mx-auto">
      <div class="flex items-center justify-between mb-6">
        <div class="heading-h2 neutral-01">{{ stepHeading() }}</div>
        <!-- Steps -->
        <div class="flex items-center gap-1">
          @for (step of steps(); track step) {
            <div
              class="rounded-full transition-all duration-200"
              [ngClass]="step === currentStep() ? 'w-8 h-2 bg-black' : step < currentStep() ? 'w-2 h-2 bg-black' : 'w-2 h-2 bg-gray-300'"
            ></div>
          }
        </div>
      </div>

      <form [formGroup]="eventForm()" (ngSubmit)="createEvent()">
        @if (currentStep() === 1) {
          <div class="flex flex-col gap-6">
            <!-- Media Upload Section -->
            <div>
              @if (mediaItems().length) {
                <div #swiperEl class="swiper">
                  <div class="swiper-wrapper">
                    @for (item of mediaItems(); track item.id) {
                      <div class="swiper-slide">
                        <div class="slide-content">
                          <div class="slide-image">
                            <!-- IMAGE -->
                            @if (item.type === 'image' || item.type === 'gif') {
                              <img src="{{ item.url }}" />
                            }

                            <!-- VIDEO -->
                            @if (item.type === 'video') {
                              <video src="{{ item.url }}" controls></video>
                            }

                            <div
                              class="absolute top-2 right-2 bg-black/50 text-white rounded-full w-6 h-6 flex items-center justify-center cursor-pointer"
                              (click)="deleteMedia($index)"
                            >
                              <i class="pi pi-times"></i>
                            </div>
                          </div>
                        </div>
                      </div>
                    }
                  </div>
                </div>
                <div #scrollContainer class="thumbnail-container" cdkDropList cdkDropListOrientation="horizontal" (cdkDropListDropped)="drop($event)">
                  @for (item of mediaItems(); track item.id) {
                    <div class="thumbnail" cdkDrag [cdkDragBoundary]="scrollContainer" (click)="goToSlide($index)">
                      <!-- IMAGE -->
                      @if (item.type === 'image' || item.type === 'gif') {
                        <img [src]="item.url" />
                      }

                      <!-- VIDEO -->
                      @if (item.type === 'video') {
                        <video [src]="item.url" muted loop></video>
                      }
                      <!-- DELETE -->
                      <div class="delete-btn" (click)="deleteMedia($index)">×</div>
                    </div>
                  }
                </div>

                <div class="mt-2">
                  <app-button label="Browse files" (click)="fileInput.click()" variant="text" class="w-full" />
                </div>
              } @else {
                <div
                  class="border-2 border-dashed border-surface-300 rounded-lg flex flex-col items-center justify-center gap-3 h-[150px] cursor-pointer"
                  (click)="fileInput.click()"
                >
                  <img src="assets/svg/imageUpload.svg" class="w-12 h-12" />

                  <div class="flex flex-col items-center gap-1">
                    <span class="body-16M text-primary">Browse files</span>
                    <div class="text-sm text-surface-500">JPG or PNG <span class="text-surface-300 text-lg">|</span> Max 10 photos, 5MB total</div>
                  </div>
                </div>
              }
              <input
                #fileInput
                type="file"
                multiple
                accept="image/jpeg,image/png,video/mp4,video/webm,video/quicktime"
                class="hidden"
                (change)="onBrowseFiles($event)"
              />
              <div class="flex items-center gap-3 my-2">
                <div class="flex-1 border-t border-surface-300"></div>
                <div class="text-surface-500 body-14M">or</div>
                <div class="flex-1 border-t border-surface-300"></div>
              </div>

              <div class="flex gap-2">
                <app-button label="Networked Gallery" (click)="openNetworkedGallery()" color="secondary" class="w-full" />
                <app-button label="Networked GIFs" (click)="openNetworkedGIFs()" color="secondary" class="w-full" />
              </div>
            </div>

            <!-- Event Title -->
            <text-input controlName="title" label="Event Title" placeholder="Select title" />

            <!-- Date -->
            <text-input
              label="Date"
              [readonly]="true"
              controlName="date"
              iconName="pi-calendar"
              (click)="openDateModal()"
              placeholder="Select date"
            />

            <!-- Duration -->
            <div class="flex flex-col gap-1">
              <label class="block neutral-02 body-14M">Duration</label>
              <div class="flex items-center gap-2 w-full">
                <!-- start time -->
                <text-input
                  [readonly]="true"
                  placeholder="Start"
                  iconName="pi-clock"
                  label="Event Starts"
                  [showLabel]="false"
                  controlName="start_time"
                  (click)="openTimeModal('start_time')"
                  class="w-full"
                />

                <!-- end time -->
                <text-input
                  [readonly]="true"
                  placeholder="End"
                  label="Event Ends"
                  iconName="pi-clock"
                  [showLabel]="false"
                  controlName="end_time"
                  [required]="!getFieldValue('until_finished')"
                  (click)="openTimeModal('end_time')"
                  class="w-full"
                />
              </div>
              <div class="flex items-center gap-2">
                <p-checkbox inputId="until_finished" formControlName="until_finished" [binary]="true" />
                <label for="until_finished" class="cursor-pointer">Until finished</label>
              </div>
            </div>

            <!-- address -->
            <text-input
              label="Address"
              [readonly]="true"
              controlName="address"
              iconName="pi-map-marker"
              placeholder="Search location"
              (click)="openLocationModal()"
            />

            <!-- Event Category -->
            <text-input
              [readonly]="true"
              iconName="pi-tag"
              controlName="category"
              label="Event Category"
              placeholder="Select category"
              (click)="openEventCategoryModal()"
            />

            <!-- Networked Meta tags -->
            <div class="flex flex-col gap-2">
              <label class="block neutral-02 body-14M">Networked Meta tags</label>
              <div
                class="relative border rounded-lg min-h-[44px] p-2 cursor-pointer bg-surface-0"
                [class.border-surface-300]="!isMetaTagsInvalid"
                [class.accent-red]="isMetaTagsInvalid"
                (click)="openNetworkTagModal()"
              >
                <div class="flex flex-wrap items-center gap-2 min-h-[28px]">
                  @if (selectedMetaTags().size === 0) {
                    <span class="text-surface-500 text-sm">Select up to 5</span>
                  } @else {
                    @for (tagValue of getSelectedTagValues(); track tagValue) {
                      @if (getTagByName(tagValue); as tag) {
                        <div
                          class="flex items-center gap-1 px-2 py-1 rounded-full bg-surface-100 border border-surface-300 text-surface-700 text-sm font-medium"
                        >
                          <span [innerHTML]="tag.icon"></span>
                          <span>{{ tag.name }}</span>
                        </div>
                      }
                    }
                  }
                </div>
                <i class="pi pi-chevron-right text-surface-400 absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none"></i>
              </div>
              @if (isMetaTagsInvalid) {
                <div class="accent-red body-12M">Please select at least one meta tag.</div>
              }
            </div>

            <!-- Description -->
            <div class="flex flex-col gap-2">
              <editor-input
                controlName="description"
                label="Description"
                placeholder="Write description here"
                [showGenerateButton]="true"
                [isCustomize]="isCustomize()"
                [onGenerateClick]="handleGenerateClick"
              />
              <div class="flex justify-end">
                <span class="text-xs text-surface-500">{{ descriptionLength() }}/{{ maxDescriptionLength }}</span>
              </div>
            </div>
          </div>
        }

        <!-- Step 2: Event Tickets -->
        @if (currentStep() === 2) {
          <!-- Add Ticket Buttons -->
          <div class="flex flex-col gap-4 pb-4">
            @if (!hasFreeTicket()) {
              <ticket-type-item
                icon="assets/svg/ticket/free-ticket.svg"
                label="Create Free Ticket"
                description="Allow guest to RSVP for free."
                alt="Free Ticket"
                (click)="createFreeTicket()"
              />
            }

            <ticket-type-item
              icon="assets/svg/ticket/paid-ticket.svg"
              label="Create Paid Ticket"
              description="Create a type of paid ticket for guests."
              alt="Paid Ticket"
              (click)="createPaidTicket()"
            />
          </div>

          <!-- Ticket List Section -->
          @if (tickets().length > 0) {
            <ion-reorder-group [disabled]="tickets().length <= 1" (ionItemReorder)="handleTicketReorder($event)">
              @for (ticket of tickets(); track ticket.id || $index; let index = $index) {
                <ticket-card
                  [ticket]="ticket"
                  [eventDate]="getFieldValue('date')"
                  [eventStartTime]="getFieldValue('start_time')"
                  (edit)="editTicket(index)"
                  (delete)="deleteTicket(index)"
                />
              }
            </ion-reorder-group>
          }

          <!-- Subscription Section -->
          @if (tickets().length > 0 && !isEventCompletelyFree()) {
            <subscription-input [plans]="storedPlans()" [onCreateSubscription]="navigateToSubscriptionPlans" />
          }

          <!-- Promo Code Section -->
          @if (tickets().length > 0) {
            <div class="py-4" [class.opacity-50]="isEventCompletelyFree()">
              <div
                class="flex items-center justify-between cursor-pointer"
                (click)="!isEventCompletelyFree() && promoCodeSectionOpen.set(!promoCodeSectionOpen())"
              >
                <div class="body-medium-16" [class.natural-03]="isEventCompletelyFree()" [class.natural-01]="!isEventCompletelyFree()">
                  Promo Code(s)
                </div>

                @if (!isEventCompletelyFree()) {
                  <i [class]="promoCodeSectionOpen() ? 'pi pi-chevron-up text-lg' : 'pi pi-chevron-down text-lg'"></i>
                }
              </div>

              @if (promoCodeSectionOpen() || isEventCompletelyFree()) {
                <div class="mt-3">
                  @if (isEventCompletelyFree()) {
                    <div class="body-regular-14 natural-03">Unapplicable to free events</div>
                  } @else {
                    @if (promoCodes()) {
                      <div class="flex flex-col gap-3">
                        @for (promo of promoCodes(); track promo.promoCode) {
                          <promo-code-card
                            [promo]="promo"
                            (edit)="editPromoCode(getPromoCodeOriginalIndex(promo))"
                            (delete)="deletePromoCode(getPromoCodeOriginalIndex(promo))"
                          />
                        }
                      </div>
                    }

                    <div class="flex justify-center pb-4">
                      <button class="body-medium-14 brand-02" (click)="resetPromoForm()">
                        <i class="pi pi-plus"></i>
                        Create New
                      </button>
                    </div>
                  }
                </div>
              }
            </div>
          }

          <!-- Advanced Settings Section -->
          @if (tickets().length > 0) {
            <div class="py-4" [class.opacity-50]="isEventCompletelyFree()" [class.pointer-events-none]="isEventCompletelyFree()">
              <div
                class="flex items-center justify-between"
                [class.cursor-pointer]="!isEventCompletelyFree()"
                [class.cursor-not-allowed]="isEventCompletelyFree()"
                (click)="!isEventCompletelyFree() && advancedSettingsOpen.set(!advancedSettingsOpen())"
              >
                <div class="body-medium-16" [class.natural-03]="isEventCompletelyFree()" [class.natural-01]="!isEventCompletelyFree()">
                  Advanced Settings
                </div>

                @if (!isEventCompletelyFree()) {
                  <i [class]="advancedSettingsOpen() ? 'pi pi-chevron-up text-lg' : 'pi pi-chevron-down text-lg'"></i>
                }
              </div>

              @if (advancedSettingsOpen() || isEventCompletelyFree()) {
                <div class="mt-3">
                  @if (isEventCompletelyFree()) {
                    <div class="body-regular-14 natural-03">Unapplicable to free events</div>
                  } @else {
                    <div class="w-full border-l-2 border-neutral-300 pl-4">
                      @if (!getFieldValue('host_pays_fees')) {
                        <div class="flex items-center gap-4 mb-2">
                          <ion-label class="body-regular-14 natural-01"> Additional fee for guests (%) </ion-label>
                          <ion-toggle formControlName="guest_fee_enabled" />
                        </div>

                        @if (getFieldValue('guest_fee_enabled')) {
                          <div class="w-[100px]">
                            <number-input
                              controlName="additional_fees"
                              placeholder="0%"
                              [max]="100"
                              [min]="0"
                              [required]="getFieldValue('guest_fee_enabled') ?? false"
                            />
                          </div>
                        }
                      }
                      <div class="flex items-center gap-3 mt-4">
                        <ion-checkbox formControlName="host_pays_fees"></ion-checkbox>

                        <div class="body-regular-14 natural-01">Hosts will pay the platform fees</div>
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          }
        }

        <!-- Step 3: Additional Settings -->
        @if (currentStep() === 3) {
          <div class="flex flex-col gap-6">
            <!-- Require RSVP Approval -->
            <toggle-input controlName="require_rsvp_approval" label="Require RSVP Approval?" />
            <!-- Repeating Event -->
            @if (!isModalMode) {
              <div>
                <toggle-input controlName="is_repeating" label="Repeating Event" />

                @if (getFieldValue('is_repeating')) {
                  <div class="w-full mt-2">
                    <div class="border-l-3 border-neutral-300 pl-3">
                      <!-- Repeat Frequency -->
                      <div class="flex gap-2 mb-4">
                        @for (item of repeatOptions(); track item.value) {
                          <chip
                            [type]="item.value"
                            [color]="getFieldValue('repeat_frequency') === item.value ? 'lgold' : ''"
                            (selectedType)="setRepeatFrequency(item.value)"
                            class="w-full"
                          >
                            <span class="body-14R flex justify-center">
                              {{ item.label }}
                            </span>
                          </chip>
                        }
                      </div>
                      <!-- Repeat Count -->
                      <label class="neutral-02 body-14M block mb-2"> How many times will the event occur in total? </label>

                      <div class="flex gap-2">
                        @for (item of repeatCountOptions(); track item.value) {
                          @if (item.value !== 'custom') {
                            <chip
                              [type]="item.value.toString()"
                              [color]="getFieldValue('repeat_count') === item.value ? 'lgold' : ''"
                              (selectedType)="handleRepeatCountClick(item.value)"
                            >
                              <span class="body-14R">
                                {{ item.label }}
                              </span>
                            </chip>
                          }
                        }

                        <!-- Show number input when custom is selected -->
                        <div>
                          <number-input
                            controlName="custom_repeat_count"
                            placeholder="0"
                            [min]="5"
                            [max]="50"
                            class="w-14"
                            placeholder="Enter custom count"
                          ></number-input>
                        </div>
                      </div>
                    </div>

                    <!-- Repeating Events List -->
                    @if (repeatingEvents().length > 0) {
                      <div class="mt-4">
                        <div class="flex flex-col gap-2">
                          @for (event of repeatingEvents(); track event.id) {
                            <repeating-event-item
                              [event]="event"
                              [isMainEvent]="event.eventNumber === 1"
                              (edit)="editRepeatingEvent(event)"
                              (delete)="deleteRepeatingEvent(event.id)"
                            />
                          }
                        </div>
                      </div>
                    }
                  </div>
                }
              </div>
            }
            <!-- Co-Hosts -->
            <participant-input label="Co-Host(s)" type="co-host" [selectedUsers]="co_hosts()" (usersChange)="onUsersChange($event, 'co_hosts')" />

            <!-- Sponsors -->
            <participant-input label="Sponsor(s)" type="sponsor" [selectedUsers]="sponsors()" (usersChange)="onUsersChange($event, 'sponsors')" />

            <!-- Speakers -->
            <participant-input label="Speaker(s)" type="speaker" [selectedUsers]="speakers()" (usersChange)="onUsersChange($event, 'speakers')" />

            <!-- Visibility -->
            <div class="flex items-center justify-between">
              <label class="neutral-02 body-14M">Visibility</label>
              <div class="flex gap-2">
                <chip [type]="visibility()" [color]="visibility() === 'public' ? 'lgold' : ''" (selectedType)="setVisibility('public')">
                  <span class="body-14R">Public</span>
                </chip>
                <chip [type]="visibility()" [color]="visibility() === 'invite-only' ? 'lgold' : ''" (selectedType)="setVisibility('invite-only')">
                  <span class="body-14R">Invite Only</span>
                </chip>
              </div>
            </div>

            <!-- Allow +1's -->
            <div>
              <toggle-input controlName="allow_plus_ones" label="Allow +1’s?" />

              @if (getFieldValue('allow_plus_ones')) {
                <div class="w-full border-l-3 border-neutral-300 pl-2 mt-2">
                  <label class="neutral-02 body-14M block mb-2"> How many additional person per guest? </label>

                  <div class="flex flex-wrap gap-3">
                    @for (item of [1, 2, 3, 4, 5, 6, 7, 8, 9]; track item) {
                      <chip [type]="item.toString()" [color]="getFieldValue('plus') === item ? 'lgold' : ''" (selectedType)="setPlusCount(item)">
                        <span class="body-14R">+{{ item }}</span>
                      </chip>
                    }
                  </div>
                </div>
              }
            </div>

            <!-- Questionnaire -->
            <div class="flex flex-col gap-3">
              <toggle-input controlName="questionnaire" label="Questionnaire" />

              @if (getFieldValue('questionnaire') !== null) {
                @for (section of sections(); track section.type) {
                  <div class="border border-surface-300 rounded-xl p-4">
                    <!-- Header Row: Title + Actions -->
                    <div class="flex items-center justify-between">
                      <div class="flex items-center gap-2">
                        @if (hasQuestions(section.type)) {
                          <img src="assets/svg/checkIcon.svg" alt="{{ section.label }}" class="w-5 h-5" />
                        }
                        <div class="font-medium text-surface-900">{{ section.label }}</div>
                      </div>

                      <div class="flex gap-4">
                        @if (!hasQuestions(section.type)) {
                          <button (click)="openQuestionnaireModal(section.type)">
                            <i class="pi pi-plus text-gray-700"></i>
                          </button>
                        } @else {
                          <button (click)="openQuestionnaireModal(section.type)">
                            <img src="assets/svg/editIcon.svg" alt="Edit" />
                          </button>

                          <button (click)="deleteEventQuestionnaire(section.type)">
                            <img src="assets/svg/deleteIcon.svg" alt="Delete" />
                          </button>
                        }
                      </div>
                    </div>

                    <!-- Content Row: List of questions or placeholder -->
                    <div class="mt-2">
                      @if (!hasQuestions(section.type)) {
                        <div class="text-sm text-gray-500">{{ section.placeholder }}</div>
                      } @else {
                        <ul class="list-disc list-inside text-sm text-gray-500 space-y-1 pl-2">
                          @for (question of getSectionQuestions(section.type); track question.id) {
                            <li>{{ question.question }}</li>
                          }
                        </ul>
                      }
                    </div>
                  </div>
                }
              }
            </div>
          </div>
        }

        <!-- Step 4: Review & Publish -->
        @if (currentStep() === 4) {
          <div class="flex flex-col gap-4">Step 4 content</div>
        }
      </form>
    </div>
  </div>
</ion-content>

<ion-footer mode="md">
  <ion-toolbar>
    <div class="p-6 max-w-[672px] mx-auto">
      @if (!isModalMode) {
        <!-- Navigation Buttons -->
        <app-button
          [label]="buttonLabel()"
          [iconName]="buttonIcon()"
          [iconPos]="iconPos()"
          [disabled]="isButtonDisabled()"
          (click)="handleButtonClick()"
        />
      } @else {
        <div class="flex items-center gap-2">
          <app-button label="Cancel" (click)="cancelModal()" class="w-full" color="secondary" />
          <app-button label="Save Changes" (click)="handleButtonClick()" class="w-full" />
        </div>
      }
    </div>
  </ion-toolbar>
</ion-footer>
