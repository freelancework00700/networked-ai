<div class="flex flex-col h-full">
  <!-- Header -->
  <div class="p-4 flex items-center justify-between">
    <button (click)="close()">
      <i class="pi pi-arrow-left text-surface-900"></i>
    </button>

    <div class="body-16M neutral-01">{{ type | titlecase }} Questionnaire</div>

    <button (click)="close()">
      <i class="pi pi-times text-surface-900"></i>
    </button>
  </div>

  <!-- Content -->
  <div class="flex-1 overflow-y-auto p-4">
    <!-- Selection Box -->

    <!-- Questions -->
    <form [formGroup]="form" class="space-y-6 mt-4">
      <div formArrayName="questions">
        <ion-reorder-group [disabled]="false" (ionItemReorder)="reorderQuestions($event)">
          @for (q of questions.controls; let i = $index; track i) {
            <div [formGroupName]="i" class="p-4">
              <!-- Title -->
              <div class="flex justify-between items-center mb-2">
                <div class="flex items-center gap-2">
                  <ion-reorder slot="start"></ion-reorder>
                  <div class="font-semibold">Question {{ i + 1 }}</div>
                </div>
                <img src="assets/svg/deleteIcon.svg" alt="delete" class="w-5 h-5" (click)="deleteQuestion(i)" />
              </div>

              <!-- Question Text -->
              <text-input [label]="'question'" [controlName]="'question'" [placeholder]="'Type your question'" [showLabel]="false" />

              <!-- Type / Visibility / Required -->
              <div class="flex items-center justify-between w-full gap-4 py-2">
                <div class="w-1/3">
                  <p-select
                    [options]="filteredQuestionTypes"
                    optionLabel="label"
                    optionValue="value"
                    formControlName="type"
                    (onChange)="changeType(i, $event.value)"
                    placeholder="Select Type"
                    class="w-full h-11"
                  >
                    <ng-template let-option pTemplate="item">
                      <div class="flex items-center gap-2">
                        @if (option.image) {
                          <img [src]="'assets/svg/' + option.image" class="w-5 h-5 object-contain" />
                        } @else {
                          <i [class]="'pi pi-' + option.icon + ' w-5 h-5 text-gray-600'"></i>
                        }

                        <div class="font-medium truncate">{{ option.label }}</div>
                      </div>
                    </ng-template>
                  </p-select>
                </div>

                <!-- Right: Visibility + Required -->
                <div class="flex items-center gap-4 w-2/4 justify-end">
                  <p-select [options]="visibilityOptions" formControlName="visibility" placeholder="Select Visibility" class="w-40 h-11">
                    <ng-template let-option pTemplate="item">
                      <div class="flex flex-col gap-1">
                        <span class="font-medium">{{ option.label }}</span>
                        <span class="text-sm text-gray-500">{{ option.description }}</span>
                      </div>
                    </ng-template>
                  </p-select>

                  <div class="flex items-center gap-2 h-11">
                    <p-checkbox formControlName="required" binary="true" inputId="'required-' + i"></p-checkbox>
                    <label [for]="'required-' + i" class="text-gray-700 font-medium">Required</label>
                  </div>
                </div>
              </div>

              <!-- Number Fields -->
              @if (q.get('type')?.value === 'Number') {
                <div class="flex gap-4 items-center">
                  <span class="body-14M neutral-02"> Answer Range</span>
                  <number-input [label]="'Min'" [controlName]="'min'" [placeholder]="'Min'" [showLabel]="false" />
                  <span class="body-14M neutral-02">to</span>
                  <number-input [label]="'Max'" [controlName]="'max'" [placeholder]="'Max'" [showLabel]="false" />
                </div>
                @if (isNumberInvalid(q)) {
                  <div class="accent-red body-12M mt-1">Min and Max required. Min must be less than Max.</div>
                }
              }

              <!-- Choice Options -->
              @if (q.get('type')?.value === 'SingleChoice' || q.get('type')?.value === 'MultipleChoice') {
                <div formArrayName="options" class="space-y-2">
                  <ion-reorder-group [disabled]="false" (ionItemReorder)="reorderOptions(i, $event)" class="flex flex-col gap-2">
                    @for (opt of getOptions(q).controls; let oi = $index; track oi) {
                      <div class="flex items-center gap-3">
                        <ion-reorder slot="start"></ion-reorder>
                        <input pInputText class="w-full h-[44px]" [placeholder]="`Option ${oi + 1}`" [formControlName]="oi" />

                        <i class="pi pi-times text-surface-700" (click)="removeOption(i, oi)"></i>
                      </div>
                    }
                  </ion-reorder-group>
                  <app-button label="Add Option" iconName="pi-plus" color="secondary" (click)="addOption(i)" [disabled]="areOptionsInvalid(q)" />
                </div>
              }

              @if (q.get('type')?.value === 'Rating') {
                <div class="flex gap-4 items-center">
                  <span class="body-14M neutral-02"> Scale</span>
                  <number-input
                    [label]="'Rating'"
                    [controlName]="'rating_scale'"
                    [placeholder]="'Rating'"
                    [showLabel]="false"
                    [min]="1"
                    [max]="10"
                    class="w-full"
                  />
                </div>
              }
            </div>
          }

          @if (showSelectionBox()) {
            <div class="space-y-2 border border-surface-300 rounded-2xl p-2 bg-surface-200 p-1">
              @for (item of filteredQuestionTypes; track item.value) {
                <div
                  class="p-4 border border-surface-300 rounded-xl flex items-center gap-4 bg-surface-100 cursor-pointer"
                  (click)="selectType(item.value)"
                >
                  @if (item.image) {
                    <img [src]="'/assets/svg/' + item.image" alt="icon" class="w-6 h-6" />
                  } @else {
                    <i [class]="'pi pi-' + item.icon + ' w-6 h-6 text-surface-700'"></i>
                  }

                  <div class="flex flex-col gap-1">
                    <div class="font-medium">{{ item.label }}</div>
                    <div class="text-sm text-gray-500">{{ item.description }}</div>
                  </div>
                </div>
              }
            </div>
          }
        </ion-reorder-group>
      </div>
    </form>
  </div>

  <!-- Footer -->
  <div class="p-4 flex items-center gap-2">
    <app-button label="Add Question" color="secondary" iconName="pi-plus" (click)="addQuestion()" class="flex-1" [disabled]="isFormInvalid()" />
    <app-button label="Save" (click)="save()" class="flex-1" [disabled]="isFormInvalid()" />
  </div>
</div>
