<ion-header mode="md">
  <ion-toolbar mode="md">
    <div class="p-4 flex items-center justify-between">
      <div class="flex flex-col">
        <div class="heading-h3 neutral-01">{{ eventTitle }}</div>
        <div class="body-14R neutral-03">by {{ hostName }}</div>
      </div>
      <i class="pi pi-times cursor-pointer text-xl text-neutral-01" (click)="close()"></i>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content mode="md">
  <div class="p-4">
    <!-- Event Details -->

    <div class="flex flex-col gap-2 mb-6">
      <div class="flex items-start gap-1.5">
        <div class="pi pi-calendar neutral-03 !text-[16px] mt-0.5"></div>
        <div class="flex items-center justify-between gap-1 w-full">
          <div class="body-14M neutral-03">Date &amp; Time</div>
          <div class="body-14M">{{ eventDate }}</div>
        </div>
      </div>

      <!-- location -->
      <div class="flex items-start gap-1.5">
        <div class="pi pi-map-marker neutral-03 !text-[16px] mt-0.5"></div>
        <div class="flex items-center justify-between gap-1 w-full">
          <div class="body-14M neutral-03">Location</div>
          <div class="body-14M">{{ eventLocation }}</div>
        </div>
      </div>
    </div>

    <form [formGroup]="form" class="flex flex-col gap-6">
      <!-- Your Details Section -->
      <div class="border border-surface-300 rounded-2xl p-4 flex flex-col gap-4">
        <div class="body-16M neutral-01">Your Details</div>

        <div class="flex gap-3">
          <text-input [controlName]="'firstName'" [label]="'First Name'" [showLabel]="true" [required]="true" class="flex-1" />
          <text-input [controlName]="'lastName'" [label]="'Last Name'" [showLabel]="true" [required]="true" class="flex-1" />
        </div>

        <email-input [controlName]="'email'" [label]="'Email'" [required]="true" />

        <mobile-input [controlName]="'mobile'" [label]="'Mobile'" [required]="true" />
      </div>

      <!-- Guest Information Section -->
      @if (totalGuestCount() > 0) {
        <div class="border border-surface-300 rounded-2xl p-4 flex flex-col gap-6">
          <div class="flex items-center justify-between">
            <div class="body-16M neutral-01">Guest Information</div>
            <span class="body-14R neutral-04">Optional</span>
          </div>

          <div class="flex flex-col gap-6">
            @for (guestForm of guestForms.controls; let i = $index; track i) {
              <div [formGroup]="$any(guestForm)" class="border border-surface-300 rounded-lg p-2 flex flex-col gap-4">
                <!-- Guest Label -->
                <div class="body-14M neutral-02">Guest #{{ i + 1 }}</div>

                <!-- Name Fields -->
                <div class="flex gap-3">
                  <text-input
                    [controlName]="'guestFirstName'"
                    [label]="''"
                    [showLabel]="false"
                    [placeholder]="'First Name'"
                    [required]="true"
                    class="flex-1"
                  />
                  <text-input
                    [controlName]="'guestLastName'"
                    [label]="''"
                    [showLabel]="false"
                    [placeholder]="'Last Name'"
                    [required]="true"
                    class="flex-1"
                  />
                </div>

                <!-- Attendance Options -->
                <div class="flex items-center justify-between gap-3">
                  <div class="flex gap-3">
                    <div
                      type="button"
                      class="py-2 px-4 rounded-[15px] border border-surface-300 cursor-pointer"
                      [class.bg-neutral-01]="getGuestAttendance(i) === 'going'"
                      [class.text-white]="getGuestAttendance(i) === 'going'"
                      [class.text-neutral-01]="getGuestAttendance(i) !== 'going'"
                      (click)="setGuestAttendance(i, 'going')"
                    >
                      Going
                    </div>
                    <div
                      type="button"
                      class="py-2 px-4 rounded-[15px] border border-surface-300 cursor-pointer"
                      [class.bg-neutral-01]="getGuestAttendance(i) === 'maybe'"
                      [class.text-white]="getGuestAttendance(i) === 'maybe'"
                      [class.text-neutral-01]="getGuestAttendance(i) !== 'maybe'"
                      (click)="setGuestAttendance(i, 'maybe')"
                    >
                      Maybe
                    </div>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="body-14M neutral-01">Incognito</span>
                    <toggle-input [controlName]="'isIncognito'" [initialValue]="false" />
                  </div>
                </div>
              </div>
            }
          </div>
        </div>
      }

      <!-- RSVP Details Section -->
      <div class="border border-surface-300 rounded-2xl p-4 flex flex-col gap-3">
        <div class="flex items-center border-b border-surface-300 pb-3 justify-between">
          <div class="body-16M neutral-01">RSVP Details</div>
          <ion-icon src="assets/svg/editIcon.svg" class="w-5 h-5 text-neutral-03" (click)="close()" />
        </div>

        @for (ticket of rsvpDataSignal()?.tickets || []; track ticket.id) {
          @if (ticket.selectedQuantity && ticket.selectedQuantity > 0) {
            <div class="flex items-center justify-between">
              <span class="body-14R neutral-02">{{ ticket.name }} x{{ ticket.selectedQuantity }}</span>
              <span class="body-14M neutral-01">${{ getTicketPrice(ticket) }}</span>
            </div>
          }
        }

        @if (hostFees() > 0) {
          <div class="flex items-center justify-between">
            <span class="body-14R neutral-02">Additional Fee</span>
            <span class="body-14M neutral-01">${{ formatCurrency(hostFees()) }}</span>
          </div>
        }

        @if (rsvpDataSignal()?.promo_code || rsvpDataSignal()?.appliedPromoCode) {
          <div class="flex items-center justify-between">
            <span class="body-14R neutral-02">{{ promoCodeDisplayName() }}</span>
            @if ((rsvpDataSignal()?.discountAmount || 0) > 0) {
              <span class="body-14M accent-red">-${{ formatCurrency(rsvpDataSignal()?.discountAmount || 0) }}</span>
            } @else {
              <span class="body-14M accent-red">-$0.00</span>
            }
          </div>
        }

        @if (platformFee() > 0 && !hostPaysFees) {
          <div class="flex items-center justify-between">
            <span class="body-14R neutral-02">Platform Fee</span>
            <span class="body-14M neutral-01">${{ formatCurrency(platformFee()) }}</span>
          </div>
        }

        @if (subscriptionId && subscriberPerk() > 0) {
          <div class="flex items-center justify-between accent-blue">
            <div class="flex items-center gap-1">
              <div class="pi pi-crown"></div>
              <span class="body-14R">Subscriber Perk</span>
            </div>
            <span class="body-14M">- ${{ formatCurrency(subscriberPerk()) }}</span>
          </div>
        }

        <div class="border-t border-surface-300 pt-3 flex items-center justify-between">
          <span class="body-16M neutral-01">Total</span>
          <span class="body-16M neutral-01">${{ formattedTotal() }}</span>
        </div>
      </div>

      <!-- Payment Section -->
      @if (totalPrice() > 0) {
        <div class="border border-surface-300 rounded-2xl p-4 flex flex-col gap-4">
          <div class="body-16M neutral-01">Payment Details</div>

          <app-stripe-payment
            [amount]="totalPrice()"
            [eventId]="eventId"
            [subtotal]="rsvpDataSignal()?.subtotal || 0"
            [total]="rsvpDataSignal()?.total || 0"
            (paymentSuccess)="onPaymentSuccess($event)"
            (paymentError)="onPaymentError($event)"
            (paymentProcessing)="onPaymentProcessing($event)"
          />
        </div>
      }
    </form>

  </div>
</ion-content>

<ion-footer mode="md">
  <ion-toolbar mode="md">
    <div class="p-4">
      <app-button 
        [label]="confirmButtonLabel()" 
        [isLoading]="isLoadingPayment()"
        [disabled]="isLoadingPayment()"
        (click)="dismiss()" 
      />
    </div>
  </ion-toolbar>
</ion-footer>
